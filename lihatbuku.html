<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lihat Buku - BUKITKACA</title>
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
    <style>
        /* (Gaya CSS lainnya tidak berubah) */
    </style>
</head>
<body>

    <header>
        <div class="menu-toggle" onclick="toggleMenu()">â˜°</div>
        <div class="logo">BUKITKACA</div>
        <nav id="navMenu">
            <a href="index.html">Beranda</a>
            <a href="pojokbaca.html">Pojok Baca</a>
            <a href="pusatinformasi.html">Pusat Informasi</a>
            <a href="upload.html">Upload</a>
            <a href="rakbuku.html">Rak Buku</a>
            <a href="bookmarks.html">Bookmarks</a>
            <a href="#" id="logout" onclick="logout()">Logout</a>
        </nav>
        <div class="header-profile-pic" id="headerProfilePic" onclick="window.location.href='profile.html'"></div>
    </header>
    <section class="pageS">DETAIL BUKU</section>
    <section class="content-section">
        <div class="bookview-title">
            <h1 id="bookTitle"></h1>
        </div>
        <div class="bookview-detail-container">
            <div class="bookview-cover">
                <img id="bookCoverImg" src="#" alt="Cover Buku">
                <button class="action-button read-button" onclick="openBook()">Baca Buku</button>
                <button class="bookmark-button" id="bookmarkButton">Tambahkan ke Bookmark</button>
            </div>
            <div class="bookview-info">
                <p><strong>Jenis Buku:</strong> <span id="bookType">Fiksi</span></p>
                <p><strong>Genre:</strong> <span id="bookGenre"></span></p>
                <p><strong>Pengupload:</strong> <span id="bookUploader"></span></p>
                <p><strong>Deskripsi:</strong></p>
                <p id="bookDescription"></p>
            </div>
        </div>
    </section>

    <footer>
        <p>&copy; 2024 BUKITKACA. Semua Hak Dilindungi.</p>
        <a href="mailto:arifalfiancanls@gmail.com">kontak@bukitkaca.com</a>.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js";
        import { getDatabase, ref as dbRef, set, push, get } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2VBOHY24RLpCL9WnEkQp3FE9ydpAdrgk",
            authDomain: "bukitkaca-65e92.firebaseapp.com",
            databaseURL: "https://bukitkaca-65e92-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bukitkaca-65e92",
            storageBucket: "bukitkaca-65e92.firebasestorage.app",
            messagingSenderId: "848017575081",
            appId: "1:848017575081:web:756445e54749aa261cadb8",
            measurementId: "G-YLP8GC5T3J"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        async function loadBookDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const bookKey = urlParams.get('bookKey');

            if (!bookKey) {
                alert('Buku tidak ditemukan!');
                return;
            }

            const bookDataRef = dbRef(database, 'books/' + bookKey);
            const snapshot = await get(bookDataRef);
            if (snapshot.exists()) {
                const book = snapshot.val();
                book.key = bookKey;
                sessionStorage.setItem('currentBook', JSON.stringify(book));
                displayBookDetails(book);
            } else {
                alert('Buku tidak ditemukan!');
                window.history.back();
            }
        }

        function displayBookDetails(book) {
            document.getElementById('bookTitle').textContent = book.title;
            document.getElementById('bookGenre').textContent = 'Genre: ' + book.genre.join(', ');
            document.getElementById('bookDescription').textContent = book.description;
            document.getElementById('bookUploader').textContent = book.uploadedBy;
            document.getElementById('bookCoverImg').src = book.coverBase64;

            // Event Listener untuk tombol Bookmark
            const bookmarkButton = document.getElementById('bookmarkButton');
            bookmarkButton.addEventListener('click', async function() {
                const userKey = 'loggedInUser'; // Ganti dengan ID pengguna yang sudah login
                const isBookmarked = await checkIfBookIsBookmarked(book.key, userKey);

                if (isBookmarked) {
                    // Hapus dari bookmark
                    await set(dbRef(database, 'bookmarks/' + userKey + '/' + book.key), null);
                    bookmarkButton.textContent = "Tambahkan ke Bookmark";
                } else {
                    // Tambahkan ke bookmark
                    await set(dbRef(database, 'bookmarks/' + userKey + '/' + book.key), true);
                    bookmarkButton.textContent = "Dihapus dari Bookmark";
                }
            });
        }

        async function checkIfBookIsBookmarked(bookKey, userKey) {
            const bookmarkRef = dbRef(database, 'bookmarks/' + userKey + '/' + bookKey);
            const snapshot = await get(bookmarkRef);
            return snapshot.exists();
        }

        document.addEventListener('DOMContentLoaded', loadBookDetails);
    </script>
</body>
</html>
