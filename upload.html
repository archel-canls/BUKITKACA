<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Buku - BUKITKACA</title>
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
    <style>
        .book-item {
            display: flex;
            flex-direction: column;
            background-color: #222;
            width: 210px;
            border-radius: 5px 15px 15px 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .book-item:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
        }

        .book-cover {
            width: 210px;
            height: 252px;
            display: flex;
            justify-content: center;
            border-radius: 5px 15px 15px 5px;
            align-items: center;
            background-color: #333;
            overflow: hidden;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <div class="menu-toggle" onclick="toggleMenu()">â˜°</div>
        <div class="logo">BUKITKACA</div>
        <nav id="navMenu">
            <a href="index.html">Beranda</a>
            <a href="pojokbaca.html">Pojok Baca</a>
            <a href="pusatinformasi.html">Pusat Informasi</a>
            <a href="upload.html" class="active">Upload</a>
            <a href="rakbuku.html">Rak Buku</a>
            <a href="bookmarks.html">Bookmarks</a>
            <a href="#" id="logout" onclick="logout()">Logout</a>
        </nav>
        <div class="header-profile-pic" id="headerProfilePic" onclick="window.location.href='profile.html'"></div>
    </header>

    <section class="content-section">
        <h1>Upload Buku</h1><br><br><br>

        <form id="upload-form" method="POST">
            <label for="judul-buku">Judul Buku:</label>
            <input type="text" id="judul-buku" name="judul-buku" required><br><br>

            <label for="jenis-buku">Jenis Buku:</label>
            <select id="jenis-buku" name="jenis-buku" required>
                <option value="">Pilih Jenis Buku</option>
                <option value="fiksi">Fiksi</option>
                <option value="nonfiksi">Nonfiksi</option>
                <option value="akademis">Akademis</option>
                <option value="komik">Komik</option>
                <option value="novel">Novel</option>
            </select><br><br>

            <label for="genre-buku">Genre Buku:</label>
            <input type="text" id="genre-buku" name="genre-buku" placeholder="Masukkan genre, pisahkan dengan koma" required><br><br>

            <label for="deskripsi-buku">Deskripsi Buku:</label>
            <textarea id="deskripsi-buku" name="deskripsi-buku" rows="4" required></textarea><br><br>

            <label for="file-buku">Unggah Buku (Harus diisi):</label>
            <input type="file" id="fileInput" name="file-buku" accept=".pdf" required><br><br>

            <label for="cover-buku">Unggah Cover Buku (Format JPG/PNG):</label>
            <input type="file" id="coverInput" name="cover-buku" accept=".jpg, .jpeg, .png" required><br><br>

            <input type="submit" value="Upload Buku"><br>
        </form>

        <h2>Daftar Buku yang Di-upload</h2>
        <div id="bookList" class="book-list"></div>
    </section>

    <footer>
        <p>&copy; 2024 BUKITKACA. Semua Hak Dilindungi.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref as dbRef, set, push, get } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2VBOHY24RLpCL9WnEkQp3FE9ydpAdrgk",
            authDomain: "bukitkaca-65e92.firebaseapp.com",
            databaseURL: "https://bukitkaca-65e92-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bukitkaca-65e92",
            storageBucket: "bukitkaca-65e92.firebasestorage.app",
            messagingSenderId: "848017575081",
            appId: "1:848017575081:web:756445e54749aa261cadb8",
            measurementId: "G-YLP8GC5T3J"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Function to resize and convert image to base64 with high quality
        function resizeImage(file, width, height) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);

                img.onload = function() {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    canvas.width = width;
                    canvas.height = height;

                    ctx.drawImage(img, 0, 0, width, height);

                    // Use a higher quality for image export
                    const resizedBase64 = canvas.toDataURL("image/jpeg", 0.95); // Set quality to 95% for better clarity
                    resolve(resizedBase64);
                };
            });
        }

        // Function to convert file to base64
        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Event listener for the form submission
        document.getElementById('upload-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const title = document.getElementById('judul-buku').value;
            const jenisBuku = document.getElementById('jenis-buku').value;
            const genreInput = document.getElementById('genre-buku').value;
            const genre = genreInput.split(',').map(g => g.trim());
            const description = document.getElementById('deskripsi-buku').value;
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const coverInput = document.getElementById('coverInput');
            const cover = coverInput.files[0];

            if (file && file.type === 'application/pdf' && cover && ['image/jpeg', 'image/png'].includes(cover.type)) {
                try {
                    const fileBase64 = await convertToBase64(file);
                    const coverBase64 = await resizeImage(cover, 210, 252); // Resize the cover to 210x252 px with high quality

                    const bookData = {
                        title: title,
                        jenisBuku: jenisBuku,
                        genre: genre,
                        description: description,
                        fileBase64: fileBase64, // Menyimpan base64 buku
                        coverBase64: coverBase64, // Menyimpan base64 cover
                    };

                    const newBookRef = push(dbRef(database, 'books/'));
                    await set(newBookRef, bookData);
                    loadBookList();
                    alert('Buku berhasil di-upload!');
                } catch (error) {
                    alert('Terjadi kesalahan saat mengonversi file.');
                }
            } else {
                alert('Harap unggah file PDF dan cover gambar dengan format JPG/PNG.');
            }
        });

// Function to load book list from Firebase
async function loadBookList() {
    const bookListContainer = document.getElementById('bookList');
    const loadingMessage = document.createElement('p');
    loadingMessage.textContent = 'Memuat Buku...';
    bookListContainer.innerHTML = ''; // Clear any existing content
    bookListContainer.appendChild(loadingMessage); // Show the loading message

    const bookDataRef = dbRef(database, 'books/');
    const snapshot = await get(bookDataRef);

    if (snapshot.exists()) {
        const books = snapshot.val();
        bookListContainer.innerHTML = ''; // Clear the loading message

        for (const key in books) {
            const book = books[key];
            const bookItem = document.createElement('div');
            bookItem.className = 'book-item';

            // Creating the book item with base64 image for cover
            bookItem.innerHTML = `
                <div class="book-cover">
                    <img src="${book.coverBase64}" alt="Cover Buku">
                </div>
                <h3>${book.title}</h3>
                <p><strong>Genre:</strong> ${book.genre.join(', ')}</p>
                <p>${book.description}</p>
            `;

            bookListContainer.appendChild(bookItem);
        }
    } else {
        bookListContainer.innerHTML = '<p>Tidak ada buku yang di-upload.</p>';
    }
}

        document.addEventListener('DOMContentLoaded', loadBookList);
    </script>
</body>
</html>
